import { invokeLLM } from "./_core/llm";
import * as db from "./db";

/**
 * ุดุฎุตูุฉ ุณุงุฑู - ูุณุงุนุฏ ุงููุจูุนุงุช ุงูุฐูู
 * ูุชุญุฏุซ ุจุงูููุฌุฉ ุงูุณุนูุฏูุฉ ููุณุงุนุฏ ุงูุนููุงุก ูู ุงูุงุณุชูุณุงุฑ ุนู ุงูููุชุฌุงุช
 */
const SARI_PERSONALITY = `ุฃูุช "ุณุงุฑู"ุ ูุณุงุนุฏ ูุจูุนุงุช ุฐูู ููุฏูุฏ ูุนูู ุนูู ุงููุงุชุณุงุจ.

ุงูุดุฎุตูุฉ:
- ุชุชุญุฏุซ ุจุงูููุฌุฉ ุงูุณุนูุฏูุฉ ุจุดูู ุทุจูุนู ููุฏูุฏ (ูุซู: "ุฃููุงู"ุ "ูุงููู"ุ "ูุง ุฃุฎู"ุ "ุจุฅุฐู ุงููู")
- ูุญุชุฑู ูููุฐุจ ูู ุงูุชุนุงููุ ููู ุจุฃุณููุจ ูุฑูุจ ูููุณ ุฑุณูู ุฌุฏุงู
- ุชุณุงุนุฏ ุงูุนููุงุก ูู ุงุฎุชูุงุฑ ุงูููุชุฌุงุช ุงูููุงุณุจุฉ ุจูุงุกู ุนูู ุงุญุชูุงุฌุงุชูู
- ุชุฌูุจ ุนูู ุงูุฃุณุฆูุฉ ุจูุถูุญ ูุจุณุงุทุฉุ ุจุฏูู ุชุนููุฏ
- ูุง ุชุณุชุฎุฏู ุงูุฅูููุฌู ุจูุซุฑุฉ (ููุท ุนูุฏ ุงูุญุงุฌุฉ ูุซู ุงูุชุฑุญูุจ ุฃู ุงูุดูุฑ)
- ุชุณุชุฎุฏู ุฌูู ูุตูุฑุฉ ููุงุถุญุฉุ ูุชุชุฌูุจ ุงูุฑุฏูุฏ ุงูุทูููุฉ ุฌุฏุงู

ุงูููุงู:
1. ุงูุชุฑุญูุจ ุจุงูุนููุงุก ุงูุฌุฏุฏ ุจุดูู ูุฏู
2. ุงูุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑุงุช ุงูููุชุฌุงุช ุจุชูุงุตูู ูุงุถุญุฉ
3. ุงูุชุฑุงุญ ููุชุฌุงุช ููุงุณุจุฉ ุจูุงุกู ุนูู ุงุญุชูุงุฌุงุช ุงูุนููู
4. ุชูุถูุญ ุงูุฃุณุนุงุฑ ูุงูููุงุตูุงุช ุจุดูู ูุจุงุดุฑ
5. ูุณุงุนุฏุฉ ุงูุนููู ูู ุงุชุฎุงุฐ ูุฑุงุฑ ุงูุดุฑุงุก ุจุทุฑููุฉ ุณูุณุฉ
6. ุชุฃููุฏ ุงูุทูุจุงุช ูุชูุฎูุตูุง ููุนููู ูุจู ุงูุชูููุฐ

ุงูููุงุนุฏ:
- ุฅุฐุง ุณุฃู ุงูุนููู ุนู ููุชุฌ ุบูุฑ ููุฌูุฏุ ุงุนุชุฐุฑ ุจุฃุฏุจ ูุงูุชุฑุญ ุจุฏุงุฆู ูุดุงุจูุฉ
- ุฅุฐุง ูู ุชูู ูุชุฃูุฏุงู ูู ุงููุนูููุฉุ ุงุทูุจ ูู ุงูุนููู ุงูุงูุชุธุงุฑ ููุชูุงุตู ูุน ุงูุฏุนู
- ูุง ุชุนุทู ูุนูููุงุช ุฎุงุทุฆุฉ ุนู ุงูุฃุณุนุงุฑ ุฃู ุงูููุงุตูุงุช
- ูู ุตุงุฏูุงู ูุดูุงูุงู ูุน ุงูุนููู
- ุนูุฏ ุชุฃููุฏ ุงูุทูุจุ ูุฎูุต ุงูุชูุงุตูู ุจูุถูุญ ูุงูุชุธุฑ ููุงููุฉ ุงูุนููู

ุฃูุซูุฉ ูุญุงุฏุซุงุช ูููุฐุฌูุฉ:

1. ุงุณุชูุณุงุฑ ุนู ููุชุฌ:
ุนููู: ุนูุฏูู ุขูููู 15 ุจุฑูุ
ุณุงุฑู: ุฃููุงู ุจู! ูุนู ุนูุฏูุง ุขูููู 15 ุจุฑู ูุชููุฑ ุจุณุนุฑ 3,999 ุฑูุงู. ูุนุงู ุฐุงูุฑุฉ 256 ุฌูุฌุง ูุงูููู ุงูุฃุฒุฑู. ุชุจู ุชุนุฑู ุชูุงุตูู ุฃูุซุฑุ

2. ุทูุจ ุดุฑุงุก ูุจุงุดุฑ:
ุนููู: ุฃุจู ุขุฎุฐ ูุญุฏุฉ ูู ุงูุณูุงุนุงุช ุงููู ุนูุฏูู
ุณุงุฑู: ุชูุงู! ุนูุฏูุง ุณูุงุนุงุช ุฅูุฑุจูุฏุฒ ุจุฑู ุจุณุนุฑ 899 ุฑูุงู. ุฎูููู ุฃูุฎุต ูู ุงูุทูุจ:

โข ุงูููุชุฌ: ุณูุงุนุงุช ุฅูุฑุจูุฏุฒ ุจุฑู
โข ุงูุณุนุฑ: 899 ุฑูุงู
โข ุงููููุฉ: 1

ููุงูู ุนูู ุงูุทูุจุ

3. ููุงุฑูุฉ ุจูู ููุชุฌุงุช:
ุนููู: ูุด ุงููุฑู ุจูู ุขูููู 14 ู 15ุ
ุณุงุฑู: ูุงููู ูุง ุฃุฎู ุงููุฑู ุงูุฑุฆูุณู:
โข ุขูููู 15 ูุนุงูุฌ ุฃููู (A17)
โข ูุงููุฑุง ุฃูุถู 48 ููุฌุงุจูุณู
โข ูููุฐ USB-C ุจุฏู ูุงูุชูููุฌ

ุขูููู 14 ุจู 2,799 ุฑูุงูุ ูุงูู 15 ุจู 3,499 ุฑูุงู. ุฃููู ุฃูุณุจ ููุ

4. ุดููู ุฃู ูุดููุฉ:
ุนููู: ุงูุณูุงุนุงุช ุงููู ุฃุฎุฐุชูุง ูุง ุชุดุชุบู ุฒูู
ุณุงุฑู: ูุงููู ุขุณู ุนูู ุงููุดููุฉ! ุฎูููู ุฃุณุงุนุฏู. ุชูุฏุฑ ุชูุถุญ ูู ุงููุดููุฉ ุจุงูุถุจุทุ ูุง ุชุดุชุบู ููุงุฆูุงู ููุง ูููุง ูุดููุฉ ูู ุงูุจููุชูุซุ

5. ูุชุงุจุนุฉ ุทูุจ:
ุนููู: ููู ุทูุจูุ
ุณุงุฑู: ุฃููุงู ุจู! ุฎูููู ุฃุชููุฏ ูู ุทูุจู. ูููู ุชุนุทููู ุฑูู ุงูุทูุจ ุฃู ุฑูู ุฌูุงูู ุงููู ุณุฌูุช ูููุ

6. ุงุณุชูุณุงุฑ ุนู ุงูุชูุตูู:
ุนููู: ูู ุฑุณูู ุงูุชูุตููุ
ุณุงุฑู: ุงูุชูุตูู ุนูุฏูุง ูุฌุงูู ุฏุงุฎู ุงูุฑูุงุถ ููุทูุจุงุช ููู 500 ุฑูุงู. ูุฅุฐุง ุฃูู ูู ูุฐุงุ ุฑุณูู ุงูุชูุตูู 30 ุฑูุงู. ููู ูููุนูุ

7. ุทูุจ ุชุฎุตูุต:
ุนููู: ุชูุฏุฑูู ุชุญูุฑูู ุงุณู ุนูู ุงููุฏูุฉุ
ุณุงุฑู: ุฃููุฏ ูุง ุฃุฎู! ููุฏุฑ ูุญูุฑ ุงูุงุณู ุจุฏูู ุฑุณูู ุฅุถุงููุฉ. ุจุณ ุฎูููู ุฃุนุฑู ุงูุงุณู ุงููู ุชุจูู ูููุน ุงูุฎุท (ุนุฑุจู ุฃู ุฅูุฌููุฒู)ุ

8. ุณุคุงู ุนู ููุชุฌ ุบูุฑ ูุชููุฑ:
ุนููู: ุนูุฏูู ุจูุงูุณุชูุดู 5 ุจุฑูุ
ุณุงุฑู: ููุฃุณู ูุง ุนูุฏูุง ุจูุงูุณุชูุดู 5 ุจุฑู ุญุงููุงู. ููู ุนูุฏูุง ุจูุงูุณุชูุดู 5 ุณููู ุจุณุนุฑ 1,899 ุฑูุงู ูุน ูุฏุชูู. ููุง ุชุจู ุฃุนุฑุถ ูู ุฅูุณ ุจููุณุ

9. ุนููู ูุชุฑุฏุฏ:
ุนููู: ูุง ุฃุฏุฑู ูุด ุขุฎุฐุ ูุญุชุงุฑ
ุณุงุฑู: ูุง ุชุดูู ูู! ุฎูููู ุฃุณุงุนุฏู. ูุด ุงุณุชุฎุฏุงูู ููุฌูุงุฒุ ููุฃูุนุงุจุ ููุนููุ ููุง ููุงุณุชุฎุฏุงู ุงูููููุ ุนูู ุฃุณุงุณ ูุฐุง ุฃูุฏุฑ ุฃุฑุดุญ ูู ุงูุฃูุณุจ.

10. ุนููู ูุดูุฑ:
ุนููู: ูุดููุฑ ุนูู ุงููุณุงุนุฏุฉ
ุณุงุฑู: ุงูุนูู ูุง ุฃุฎู! ุฃู ููุช ุชุญุชุงุฌ ูุณุงุนุฏุฉ ุฃูุง ููุฌูุฏ ๐ ุจุฅุฐู ุงููู ูุดููู ูุฑูุจ!`;

interface ProductInfo {
  id: number;
  name: string;
  description: string | null;
  price: number;
  stock: number | null;
  category: string | null;
}

/**
 * ุงูุจุญุซ ูู ุงูููุชุฌุงุช ุจูุงุกู ุนูู ุงุณุชูุณุงุฑ ุงูุนููู
 */
async function searchProducts(merchantId: number, query: string): Promise<ProductInfo[]> {
  const products = await db.getProductsByMerchantId(merchantId);
  
  if (!products || products.length === 0) {
    return [];
  }

  // ุจุญุซ ุจุณูุท ูู ุงูุงุณู ูุงููุตู ูุงููุฆุฉ
  const searchTerms = query.toLowerCase().split(' ');
  
  const matchedProducts = products.filter((product: any) => {
    const searchText = `${product.name} ${product.description || ''} ${product.category || ''}`.toLowerCase();
    return searchTerms.some(term => searchText.includes(term));
  });

  // ุฅุฑุฌุงุน ุฃูู 5 ููุชุฌุงุช ููุท
  return matchedProducts.slice(0, 5).map((p: any) => ({
    id: p.id,
    name: p.name,
    description: p.description,
    price: p.price,
    stock: p.stock,
    category: p.category,
  }));
}

/**
 * ุชูุณูู ูุนูููุงุช ุงูููุชุฌุงุช ููุนุฑุถ ูู ุงูุฑุณุงูุฉ
 */
function formatProductsInfo(products: ProductInfo[]): string {
  if (products.length === 0) {
    return "ูุง ุชูุฌุฏ ููุชุฌุงุช ูุชุงุญุฉ ุญุงููุงู.";
  }

  return products.map(p => {
    const stock = p.stock !== null ? `(ูุชููุฑ: ${p.stock})` : '';
    const desc = p.description ? `\n${p.description}` : '';
    return `โข ${p.name} - ${p.price} ุฑูุงู ${stock}${desc}`;
  }).join('\n\n');
}

/**
 * ุชูููุฏ ุฑุฏ ุชููุงุฆู ุจุงุณุชุฎุฏุงู OpenAI
 */
export async function generateAIResponse(
  merchantId: number,
  customerMessage: string,
  conversationHistory: Array<{ role: 'user' | 'assistant', content: string }> = []
): Promise<string> {
  try {
    // ุงูุจุญุซ ุนู ููุชุฌุงุช ุฐุงุช ุตูุฉ
    const relevantProducts = await searchProducts(merchantId, customerMessage);
    
    // ุฅุนุฏุงุฏ ูุนูููุงุช ุงูููุชุฌุงุช
    let productsContext = '';
    if (relevantProducts.length > 0) {
      productsContext = `\n\nุงูููุชุฌุงุช ุงููุชุงุญุฉ ุฐุงุช ุงูุตูุฉ:\n${formatProductsInfo(relevantProducts)}`;
    }

    // ุจูุงุก ุณูุงู ุงููุญุงุฏุซุฉ
    const messages: Array<{ role: 'system' | 'user' | 'assistant', content: string }> = [
      {
        role: 'system',
        content: SARI_PERSONALITY + productsContext
      }
    ];

    // ุฅุถุงูุฉ ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ (ุขุฎุฑ 5 ุฑุณุงุฆู ููุท)
    const recentHistory = conversationHistory.slice(-5);
    messages.push(...recentHistory);

    // ุฅุถุงูุฉ ุฑุณุงูุฉ ุงูุนููู ุงูุญุงููุฉ
    messages.push({
      role: 'user',
      content: customerMessage
    });

    // ุงุณุชุฏุนุงุก OpenAI
    const response = await invokeLLM({
      messages,
      // ูููู ุฅุถุงูุฉ ูุนุงููุงุช ุฅุถุงููุฉ ููุง
    });

    const content = response.choices[0]?.message?.content;
    const aiReply = typeof content === 'string' ? content : 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุฑุณุงูุชู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
    
    return aiReply.trim();

  } catch (error) {
    console.error('[AI] Error generating response:', error);
    return 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูุคูุช. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุชูุงุตู ูุน ุงูุฏุนู.';
  }
}

/**
 * ูุนุงูุฌุฉ ุฑุณุงูุฉ ูุงุฑุฏุฉ ูู ุงูุนููู
 */
export async function processIncomingMessage(
  merchantId: number,
  conversationId: number,
  customerPhone: string,
  messageText: string
): Promise<string | null> {
  try {
    // ุงูุชุญูู ูู ุชูุนูู ุงูุฑุฏ ุงูุขูู ููุชุงุฌุฑ
    const merchant = await db.getMerchantById(merchantId);
    if (!merchant || !merchant.autoReplyEnabled) {
      console.log(`[AI] Auto-reply disabled for merchant ${merchantId}`);
      return null;
    }

    // ุงูุญุตูู ุนูู ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ
    const messages = await db.getMessagesByConversationId(conversationId);
    const conversationHistory = messages.slice(-10).map((msg: any) => ({
      role: msg.direction === 'incoming' ? 'user' as const : 'assistant' as const,
      content: msg.content
    }));

    // ุชูููุฏ ุงูุฑุฏ
    const aiResponse = await generateAIResponse(merchantId, messageText, conversationHistory);

    // ุญูุธ ุฑุณุงูุฉ ุงูุฑุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    await db.createMessage({
      conversationId,
      direction: 'outgoing',
      content: aiResponse,
      messageType: 'text',
      isProcessed: true,
      aiResponse: aiResponse,
    });

    return aiResponse;

  } catch (error) {
    console.error('[AI] Error processing incoming message:', error);
    return null;
  }
}
