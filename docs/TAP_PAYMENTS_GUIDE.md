# ุฏููู ูุธุงู ุงูุฏูุน Tap Payments - ุณุงุฑู

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฏูุฌ ูุธุงู ุงูุฏูุน Tap Payments ุจุงููุงูู ูุน ููุตุฉ ุณุงุฑู ูุชูููุฑ ุชุฌุฑุจุฉ ุฏูุน ุณูุณุฉ ูุขููุฉ ููุนููุงุก. ูุดูู ุงููุธุงู:

1. **ุฅูุดุงุก ุฑูุงุจุท ุฏูุน ุชููุงุฆูุฉ** ุนูุฏ ุชุฃููุฏ ุงูุทูุจุงุช ูุงูุญุฌูุฒุงุช
2. **ุฅุฑุณุงู ุฑูุงุจุท ุงูุฏูุน ุนุจุฑ ูุงุชุณุงุจ** ูุจุงุดุฑุฉ ููุนููุงุก
3. **ูุนุงูุฌุฉ Webhooks ุงูุชููุงุฆูุฉ** ูู Tap ูุชุญุฏูุซ ุญุงูุฉ ุงููุนุงููุงุช
4. **ุฅุดุนุงุฑุงุช ูุงุชุณุงุจ ุงูุชููุงุฆูุฉ** ุนูุฏ ูุฌุงุญ ุฃู ูุดู ุงูุฏูุน
5. **ุตูุญุฉ ุชูุงุตูู ุดุงููุฉ** ููู ูุนุงููุฉ ูุน ุณุฌู ูุงูู

---

## ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. ุฏูุฌ ุฑูุงุจุท ุงูุฏูุน ูุน WhatsApp Bot

#### ุงูุทูุจุงุช (Orders)
ุนูุฏ ุฅูุดุงุก ุทูุจ ูู ูุญุงุฏุซุฉ ูุงุชุณุงุจ:
- ูุชู ุฅูุดุงุก ุฑุงุจุท ุฏูุน Tap ุชููุงุฆูุงู
- ููุฑุณู ุงูุฑุงุจุท ููุฑุงู ููุนููู ุนุจุฑ ูุงุชุณุงุจ
- ุงูุฑุงุจุท ุตุงูุญ ููุฏุฉ 24 ุณุงุนุฉ
- ูุญุชูู ุนูู ุฌููุน ุชูุงุตูู ุงูุทูุจ

**ูุซุงู ุนูู ุงูุฑุณุงูุฉ:**
```
๐ณ ุฑุงุจุท ุงูุฏูุน ุฌุงูุฒ!

๐ฆ ุฑูู ุงูุทูุจ: ORD-12345
๐ฐ ุงููุจูุบ: 250.00 ุฑูุงู

๐ ูุฅุชูุงู ุงูุฏูุน ุจุดูู ุขูู:
https://tap.company/pay/xxxxx

โ ุงูุฏูุน ูุคูู ุจุงููุงูู ุนุจุฑ Tap Payments
โฐ ุงูุฑุงุจุท ุตุงูุญ ููุฏุฉ 24 ุณุงุนุฉ
๐ฑ ุณุชุตูู ุฑุณุงูุฉ ุชุฃููุฏ ููุฑ ุฅุชูุงู ุงูุฏูุน

ุดูุฑุงู ูุซูุชู ุจูุง! ๐
```

#### ุงูุญุฌูุฒุงุช (Bookings)
ุนูุฏ ุฅูุดุงุก ุญุฌุฒ ูู ูุญุงุฏุซุฉ ูุงุชุณุงุจ:
- ูุชู ุฅูุดุงุก ุฑุงุจุท ุฏูุน Tap ุชููุงุฆูุงู
- ููุฑุณู ุงูุฑุงุจุท ูุน ุชูุงุตูู ุงูุญุฌุฒ
- ูุชู ุชุฃููุฏ ุงูุญุฌุฒ ููุฑ ุฅุชูุงู ุงูุฏูุน

**ูุซุงู ุนูู ุงูุฑุณุงูุฉ:**
```
๐ณ ุฑุงุจุท ุงูุฏูุน ุฌุงูุฒ!

๐ ุงูุญุฌุฒ: ูุต ุดุนุฑ ุฑุฌุงูู
๐ ุงูุชุงุฑูุฎ: 2024-01-15
โฐ ุงูููุช: 10:00 - 10:30
๐ฐ ุงููุจูุบ: 50 ุฑูุงู

๐ ูุฅุชูุงู ุงูุฏูุน:
https://tap.company/pay/xxxxx

โ ุงูุฏูุน ูุคูู ุนุจุฑ Tap Payments
โฐ ุงูุฑุงุจุท ุตุงูุญ ููุฏุฉ 24 ุณุงุนุฉ

ุดูุฑุงู ูุซูุชู! ๐
```

---

### 2. ูุนุงูุฌุฉ Webhooks ุงูุชููุงุฆูุฉ

ูุณุชูุจู ุงููุธุงู ุฅุดุนุงุฑุงุช ูู Tap ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูุฏูุน:

#### ุงูุญุงูุงุช ุงููุฏุนููุฉ:
- **CAPTURED**: ุฏูุน ูุงุฌุญ โ
- **FAILED**: ุฏูุน ูุงุดู โ
- **DECLINED**: ุฏูุน ูุฑููุถ โ
- **CANCELLED**: ุฏูุน ููุบู ๐ซ
- **REFUNDED**: ุงุณุชุฑุฌุงุน ุงููุจูุบ ๐ธ

#### ุงูุฅุฌุฑุงุกุงุช ุงูุชููุงุฆูุฉ:

**ุนูุฏ ูุฌุงุญ ุงูุฏูุน (CAPTURED):**
1. ุชุญุฏูุซ ุญุงูุฉ ุงููุนุงููุฉ ุฅูู "ููุชูู"
2. ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ/ุงูุญุฌุฒ ุฅูู "ูุฏููุน/ูุคูุฏ"
3. ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฃููุฏ ููุนููู ุนุจุฑ ูุงุชุณุงุจ
4. ุญูุธ ุณุฌู ุงูู webhook

**ุฑุณุงูุฉ ุงููุฌุงุญ ููุทูุจ:**
```
โ ุชู ุงุณุชูุงู ุงูุฏูุน ุจูุฌุงุญ!

๐ฆ ุฑูู ุงูุทูุจ: ORD-12345
๐ฐ ุงููุจูุบ: 250.00 ุฑูุงู

๐ ุทูุจู ููุฏ ุงููุนุงูุฌุฉ ุงูุขู
๐ฑ ุณูุฑุณู ูู ุชุญุฏูุซุงุช ุนู ุญุงูุฉ ุงูุดุญู

ุดูุฑุงู ูุซูุชู ุจูุง! ๐
```

**ุนูุฏ ูุดู ุงูุฏูุน (FAILED/DECLINED):**
1. ุชุญุฏูุซ ุญุงูุฉ ุงููุนุงููุฉ ุฅูู "ูุงุดู"
2. ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ/ุงูุญุฌุฒ ุฅูู "ูุดู ุงูุฏูุน/ููุบู"
3. ุฅุฑุณุงู ุฑุณุงูุฉ ููุนููู ูุน ุฎูุงุฑ ุฅุนุงุฏุฉ ุงููุญุงููุฉ

**ุฑุณุงูุฉ ุงููุดู:**
```
โ ูุดูุช ุนูููุฉ ุงูุฏูุน

๐ฆ ุฑูู ุงูุทูุจ: ORD-12345

ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุชูุงุตู ูุนูุง ูููุณุงุนุฏุฉ.

ูุนุชุฐุฑ ุนู ุงูุฅุฒุนุงุฌ ๐
```

---

### 3. ุตูุญุฉ ุชูุงุตูู ุงููุนุงููุฉ

ุตูุญุฉ ุดุงููุฉ ูุนุฑุถ ุฌููุน ูุนูููุงุช ุงููุนุงููุฉ:

#### ุงููุนูููุงุช ุงููุนุฑูุถุฉ:
- **ูุนูููุงุช ุงููุนุงููุฉ**: ุฑูู ุงููุนุงููุฉุ ุงูุญุงูุฉุ ุงูุชุงุฑูุฎ
- **ุงููุจูุบ**: ุงููุจูุบ ุงูุฅุฌูุงูู ุจุงูุนููุฉ
- **ูุนูููุงุช ุงูุนููู**: ุงูุงุณูุ ุงูุฌูุงูุ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- **ูุนูููุงุช ุงูุฏูุน**: ูุนุฑู Tapุ ุทุฑููุฉ ุงูุฏูุนุ ุงููุตู
- **ุณุฌู ุงูุชุญุฏูุซุงุช (Timeline)**: ุฌููุน ุงูุชุญุฏูุซุงุช ูุน ุงูุชูุงุฑูุฎ
- **ุงูุทูุจ/ุงูุญุฌุฒ ุงููุฑุชุจุท**: ุฑุงุจุท ูุจุงุดุฑ ููุทูุจ ุฃู ุงูุญุฌุฒ

#### ุงูุฅุฌุฑุงุกุงุช ุงููุชุงุญุฉ:
- โ **ุทุจุงุนุฉ ุงูุฅูุตุงู**: ุทุจุงุนุฉ ูุจุงุดุฑุฉ ูู ุงููุชุตูุญ
- โ **ุชุตุฏูุฑ PDF**: ุชุญููู ุงูุฅูุตุงู ุจุตูุบุฉ PDF
- โ **ุชุตุฏูุฑ JSON**: ุชุญููู ุงูุจูุงูุงุช ุงููุงููุฉ
- โ **ุฅุฑุณุงู ุนุจุฑ ูุงุชุณุงุจ**: ุฅุฑุณุงู ุงูุฅูุตุงู ููุนููู

---

## ุงูุจููุฉ ุงูุชูููุฉ

### ุงููููุงุช ุงูุฑุฆูุณูุฉ

#### Backend:
```
server/
โโโ _core/
โ   โโโ tapPayments.ts          # ุฏูุงู Tap API
โโโ automation/
โ   โโโ order-from-chat.ts      # ุฏูุฌ ุฑูุงุจุท ุงูุฏูุน ูุน ุงูุทูุจุงุช
โโโ webhooks/
โ   โโโ tap-webhook.ts          # ูุนุงูุฌ Webhooks
โ   โโโ tap-webhook.test.ts     # ุงุฎุชุจุงุฑุงุช Webhooks
โโโ db_payments.ts              # ุฏูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โโโ routers.ts                  # APIs (payments.handleWebhook)
```

#### Frontend:
```
client/src/pages/
โโโ PaymentDetails.tsx          # ุตูุญุฉ ุชูุงุตูู ุงููุนุงููุฉ
โโโ merchant/
    โโโ Payments.tsx            # ูุงุฆูุฉ ุงููุนุงููุงุช
    โโโ PaymentLinks.tsx        # ุฑูุงุจุท ุงูุฏูุน
```

### ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### ุฌุฏุงูู ุงูุฏูุน:
1. **order_payments**: ูุนุงููุงุช ุงูุฏูุน
2. **payment_links**: ุฑูุงุจุท ุงูุฏูุน
3. **payment_refunds**: ุนูููุงุช ุงูุงุณุชุฑุฌุงุน

---

## ุงูุฅุนุฏุงุฏุงุช ุงููุทููุจุฉ

### ูุชุบูุฑุงุช ุงูุจูุฆุฉ (Environment Variables):

```env
# Tap Payments API Keys
TAP_SECRET_KEY=sk_test_xxxxx           # ููุชุงุญ Tap ุงูุณุฑู
TAP_PUBLIC_KEY=pk_test_xxxxx           # ููุชุงุญ Tap ุงูุนุงู
TAP_WEBHOOK_SECRET=whsec_xxxxx         # ุณุฑ ุงูุชุญูู ูู Webhooks
```

### ุฅุนุฏุงุฏ Webhooks ูู Tap:

1. ุชุณุฌูู ุงูุฏุฎูู ุฅูู [ููุญุฉ ุชุญูู Tap](https://dashboard.tap.company)
2. ุงูุงูุชูุงู ุฅูู Settings โ Webhooks
3. ุฅุถุงูุฉ Webhook URL ุงูุฌุฏูุฏ:
   ```
   https://your-domain.com/api/trpc/payments.handleWebhook
   ```
4. ุชูุนูู ุงูุฃุญุฏุงุซ ุงูุชุงููุฉ:
   - `charge.captured`
   - `charge.failed`
   - `charge.declined`
   - `charge.cancelled`
   - `charge.refunded`

---

## APIs ุงููุชุงุญุฉ

### 1. ุฅูุดุงุก ูุนุงููุฉ ุฏูุน
```typescript
trpc.payments.createCharge.useMutation({
  amount: 100,
  currency: 'SAR',
  customerName: 'ุฃุญูุฏ ูุญูุฏ',
  customerPhone: '+966501234567',
  description: 'ุทูุจ ุฑูู ORD-12345',
  orderId: 123,
  redirectUrl: 'https://example.com/success',
});
```

### 2. ุงูุชุญูู ูู ุญุงูุฉ ุงูุฏูุน
```typescript
trpc.payments.verifyPayment.useQuery({
  chargeId: 'chg_xxxxx'
});
```

### 3. ุงูุญุตูู ุนูู ุชูุงุตูู ูุนุงููุฉ
```typescript
trpc.payments.getById.useQuery({
  id: 123
});
```

### 4. ูุงุฆูุฉ ุงููุนุงููุงุช
```typescript
trpc.payments.list.useQuery({
  status: 'captured',
  limit: 50
});
```

### 5. ุฅุญุตุงุฆูุงุช ุงูุฏูุน
```typescript
trpc.payments.getStats.useQuery({
  startDate: '2024-01-01',
  endDate: '2024-01-31'
});
```

### 6. ุฅูุดุงุก ุงุณุชุฑุฌุงุน
```typescript
trpc.payments.createRefund.useMutation({
  paymentId: 123,
  amount: 50,
  reason: 'ุทูุจ ุงูุนููู'
});
```

### 7. ูุนุงูุฌุฉ Webhook
```typescript
trpc.payments.handleWebhook.useMutation({
  payload: webhookData,
  signature: 'signature_from_tap'
});
```

---

## ุชุฏูู ุงูุนูู ุงููุงูู

### ุณููุงุฑูู 1: ุทูุจ ูู ูุงุชุณุงุจ

```mermaid
sequenceDiagram
    ุงูุนููู->>ูุงุชุณุงุจ: "ุฃุจู ุฃุทูุจ ููุชุฌ X"
    ูุงุชุณุงุจ->>ุณุงุฑู: ุฑุณุงูุฉ ุงูุทูุจ
    ุณุงุฑู->>AI: ุชุญููู ุงูุทูุจ
    AI->>ุณุงุฑู: ุชูุงุตูู ุงูุทูุจ
    ุณุงุฑู->>Salla: ุฅูุดุงุก ุทูุจ
    Salla->>ุณุงุฑู: ุชุฃููุฏ ุงูุทูุจ
    ุณุงุฑู->>Tap: ุฅูุดุงุก ุฑุงุจุท ุฏูุน
    Tap->>ุณุงุฑู: ุฑุงุจุท ุงูุฏูุน
    ุณุงุฑู->>ูุงุชุณุงุจ: ุฅุฑุณุงู ุฑุงุจุท ุงูุฏูุน
    ูุงุชุณุงุจ->>ุงูุนููู: ุฑุงุจุท ุงูุฏูุน
    ุงูุนููู->>Tap: ุฅุชูุงู ุงูุฏูุน
    Tap->>ุณุงุฑู: Webhook (CAPTURED)
    ุณุงุฑู->>DB: ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
    ุณุงุฑู->>ูุงุชุณุงุจ: ุฑุณุงูุฉ ุชุฃููุฏ
    ูุงุชุณุงุจ->>ุงูุนููู: ุชุฃููุฏ ุงูุฏูุน
```

### ุณููุงุฑูู 2: ุญุฌุฒ ูู ูุงุชุณุงุจ

```mermaid
sequenceDiagram
    ุงูุนููู->>ูุงุชุณุงุจ: "ุฃุจู ุฃุญุฌุฒ ููุนุฏ"
    ูุงุชุณุงุจ->>ุณุงุฑู: ุฑุณุงูุฉ ุงูุญุฌุฒ
    ุณุงุฑู->>AI: ุชุญููู ุทูุจ ุงูุญุฌุฒ
    AI->>ุณุงุฑู: ุชูุงุตูู ุงูุญุฌุฒ
    ุณุงุฑู->>DB: ุฅูุดุงุก ุญุฌุฒ
    ุณุงุฑู->>Tap: ุฅูุดุงุก ุฑุงุจุท ุฏูุน
    Tap->>ุณุงุฑู: ุฑุงุจุท ุงูุฏูุน
    ุณุงุฑู->>ูุงุชุณุงุจ: ุฅุฑุณุงู ุฑุงุจุท ุงูุฏูุน
    ูุงุชุณุงุจ->>ุงูุนููู: ุฑุงุจุท ุงูุฏูุน
    ุงูุนููู->>Tap: ุฅุชูุงู ุงูุฏูุน
    Tap->>ุณุงุฑู: Webhook (CAPTURED)
    ุณุงุฑู->>DB: ุชุญุฏูุซ ุญุงูุฉ ุงูุญุฌุฒ
    ุณุงุฑู->>ูุงุชุณุงุจ: ุฑุณุงูุฉ ุชุฃููุฏ
    ูุงุชุณุงุจ->>ุงูุนููู: ุชุฃููุฏ ุงูุญุฌุฒ
```

---

## ุงูุฃูุงู

### ุงูุชุญูู ูู Webhooks:
- ูุชู ุงูุชุญูู ูู ุชูููุน HMAC SHA256 ููู webhook
- ูุชู ุฑูุถ ุฃู webhook ุจุชูููุน ุบูุฑ ุตุญูุญ
- ูุชู ุญูุธ ุณุฌู ูุฌููุน ุงูู webhooks

### ุชุดููุฑ ุงูุจูุงูุงุช:
- ุฌููุน ุงูุงุชุตุงูุงุช ูุน Tap ุนุจุฑ HTTPS
- ูุง ูุชู ุญูุธ ุจูุงูุงุช ุงูุจุทุงูุงุช ูู ุงููุธุงู
- ูุชู ุญูุธ ูุนุฑู ุงููุนุงููุฉ ููุท

---

## ุงูุงุฎุชุจุงุฑ

### ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช:
```bash
pnpm test server/webhooks/tap-webhook.test.ts
```

### ุงุฎุชุจุงุฑุงุช ูุชุงุญุฉ:
- โ ุงูุชุญูู ูู ุงูุชูููุน ุงูุตุญูุญ
- โ ุฑูุถ ุงูุชูููุน ุงูุฎุงุทุฆ
- โ ูุนุงูุฌุฉ ุฏูุน ูุงุฌุญ
- โ ูุนุงูุฌุฉ ุฏูุน ูุงุดู
- โ ูุนุงูุฌุฉ webhook ููุนุงููุฉ ุบูุฑ ููุฌูุฏุฉ

---

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดููุฉ: ูุง ูุชู ุฅุฑุณุงู ุฑุงุจุท ุงูุฏูุน

**ุงูุญููู:**
1. ุชุญูู ูู ูุฌูุฏ `TAP_SECRET_KEY` ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
2. ุชุญูู ูู ุงุชุตุงู Green API
3. ุฑุงุฌุน logs ุงูุณูุฑูุฑ ููุฃุฎุทุงุก

### ูุดููุฉ: Webhook ูุง ูุนูู

**ุงูุญููู:**
1. ุชุญูู ูู URL ุงูู webhook ูู ููุญุฉ Tap
2. ุชุญูู ูู `TAP_WEBHOOK_SECRET`
3. ุชุญูู ูู ุฃู ุงูุณูุฑูุฑ ููุจู POST requests

### ูุดููุฉ: ุญุงูุฉ ุงูุฏูุน ูุง ุชุชุญุฏุซ

**ุงูุญููู:**
1. ุชุญูู ูู logs ุงูู webhooks
2. ุชุญูู ูู ุญุงูุฉ ุงููุนุงููุฉ ูู ููุญุฉ Tap
3. ุฃุนุฏ ุฅุฑุณุงู ุงูู webhook ูู ููุญุฉ Tap

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ุชุญุณููุงุช ูุณุชูุจููุฉ:
- [ ] ุฏุนู ุงูุฏูุน ุจุงูุชูุณูุท
- [ ] ุฏุนู Apple Pay ู Google Pay
- [ ] ุชูุงุฑูุฑ ูุงููุฉ ูุชูุฏูุฉ
- [ ] ุฏุนู ุนููุงุช ุฅุถุงููุฉ
- [ ] ูุธุงู ุงุณุชุฑุฌุงุน ุฌุฒุฆู
- [ ] ุฅุดุนุงุฑุงุช ุจุฑูุฏ ุฅููุชุฑููู

---

## ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุงุณุชูุณุงุฑุงุช:
- ๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: support@sari.sa
- ๐ฑ ูุงุชุณุงุจ: +966 XX XXX XXXX
- ๐ ุงููููุน: https://sari.sa

---

**ุขุฎุฑ ุชุญุฏูุซ:** ููุงูุฑ 2024
**ุงูุฅุตุฏุงุฑ:** 1.0.0
